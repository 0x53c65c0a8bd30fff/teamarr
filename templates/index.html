{% extends "base.html" %}

{% block title %}Dashboard - Teamarr{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1>Dashboard</h1>
            <p class="page-subtitle">Overview of your EPG system</p>
        </div>
        <div class="page-actions">
            <a href="{{ url_for('templates_add_form') }}" class="btn btn-primary">
                ‚ûï Create Template
            </a>
            <a href="{{ url_for('teams_import') }}" class="btn btn-secondary">
                üì• Import Teams
            </a>
            <button onclick="generateEPGWithProgress()" class="btn btn-success" id="generate-epg-btn" style="vertical-align: top;">
                üöÄ Generate EPG
            </button>
        </div>
    </div>

    <!-- Templates Summary -->
    <div class="section">
        <div class="section-header">
            <h2>Templates</h2>
            <a href="{{ url_for('templates_list') }}" class="manage-link">Manage ‚Üí</a>
        </div>
        <div class="stats-grid stats-grid-compact">
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üìã</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ template_count }}</div>
                    <div class="stat-label-compact">Total</div>
                </div>
            </div>
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üèÜ</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ team_template_count }}</div>
                    <div class="stat-label-compact">Teams</div>
                </div>
            </div>
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üéØ</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ event_template_count }}</div>
                    <div class="stat-label-compact">Events</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teams Summary -->
    <div class="section">
        <div class="section-header">
            <h2>Teams</h2>
            <a href="{{ url_for('teams_list') }}" class="manage-link">Manage ‚Üí</a>
        </div>
        <div class="stats-grid stats-grid-compact">
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üèÜ</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ team_count }}</div>
                    <div class="stat-label-compact">Total</div>
                </div>
            </div>
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ active_team_count }}</div>
                    <div class="stat-label-compact">Active</div>
                </div>
            </div>
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üîó</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ assigned_team_count }}</div>
                    <div class="stat-label-compact">Assigned</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Events Summary -->
    <div class="section">
        <div class="section-header">
            <h2>Events</h2>
            <a href="{{ url_for('event_groups_list') }}" class="manage-link">Manage ‚Üí</a>
        </div>
        <div class="stats-grid stats-grid-compact">
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üìÅ</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ event_group_count }}</div>
                    <div class="stat-label-compact">Groups</div>
                </div>
            </div>
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ enabled_event_group_count }}</div>
                    <div class="stat-label-compact">Enabled</div>
                </div>
            </div>
            <div class="stat-card stat-card-compact">
                <div class="stat-icon-compact">üì∫</div>
                <div class="stat-content">
                    <div class="stat-value-compact">{{ managed_channel_count }}</div>
                    <div class="stat-label-compact">Channels</div>
                </div>
            </div>
        </div>
    </div>

    <!-- EPG Summary -->
    {% if latest_epg or matched_event_streams > 0 %}
        <div class="section">
            <div class="section-header">
                <h2>EPG Summary</h2>
                <a href="{{ url_for('epg_management') }}" class="manage-link">Manage ‚Üí</a>
            </div>
            <!-- Row 1: Channels -->
            <div class="stats-grid stats-grid-compact">
                <div class="stat-card stat-card-compact epg-stat">
                    <div class="stat-icon-compact">üì∫</div>
                    <div class="stat-content">
                        <div class="stat-value-compact">{{ (latest_epg.num_channels if latest_epg else 0) + matched_event_streams }}</div>
                        <div class="stat-label-compact">Total Channels</div>
                    </div>
                </div>
                <div class="stat-card stat-card-compact epg-stat">
                    <div class="stat-icon-compact">üèÜ</div>
                    <div class="stat-content">
                        <div class="stat-value-compact">{{ latest_epg.num_channels if latest_epg else 0 }}</div>
                        <div class="stat-label-compact">Team Channels</div>
                    </div>
                </div>
                <div class="stat-card stat-card-compact epg-stat">
                    <div class="stat-icon-compact">üéØ</div>
                    <div class="stat-content">
                        <div class="stat-value-compact">{{ matched_event_streams }}</div>
                        <div class="stat-label-compact">Event Channels</div>
                    </div>
                </div>
            </div>
            <!-- Row 2: Programs -->
            <div class="stats-grid stats-grid-compact">
                <div class="stat-card stat-card-compact epg-stat">
                    <div class="stat-icon-compact">üé¨</div>
                    <div class="stat-content">
                        <div class="stat-value-compact">{{ latest_epg.num_events if latest_epg else 0 }}</div>
                        <div class="stat-label-compact">Events</div>
                    </div>
                </div>
                <div class="stat-card stat-card-compact epg-stat">
                    <div class="stat-icon-compact">üìä</div>
                    <div class="stat-content">
                        <div class="stat-value-compact">{{ (latest_epg.num_programmes - latest_epg.num_events) if latest_epg else 0 }}</div>
                        <div class="stat-label-compact">Filler Programs</div>
                    </div>
                </div>
                <div class="stat-card stat-card-compact epg-stat">
                    <div class="stat-icon-compact">üìÖ</div>
                    <div class="stat-content">
                        <div class="stat-value-tiny">{{ latest_epg.generated_at_formatted if latest_epg else 'Never' }}</div>
                        <div class="stat-label-compact">Last Generated</div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- EPG Generation History Table -->
    {% if epg_history %}
        <div class="section">
            <h2>EPG Generation History</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Generated At</th>
                            <th>Channels</th>
                            <th>Events</th>
                            <th>Programs</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in epg_history %}
                            <tr>
                                <td>{{ entry.generated_at_formatted }}</td>
                                <td class="text-center">{{ entry.num_channels }}</td>
                                <td class="text-center">{{ entry.num_events }}</td>
                                <td class="text-center">{{ entry.num_programmes }}</td>
                                <td class="text-center">
                                    {% if entry.generation_time_seconds %}
                                        {{ "%.2f"|format(entry.generation_time_seconds) }}s
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if entry.status == 'success' %}
                                        <span class="status-badge status-success">‚úì Success</span>
                                    {% elif entry.status == 'error' %}
                                        <span class="status-badge status-error">‚úó Error</span>
                                    {% elif entry.status == 'partial' %}
                                        <span class="status-badge status-warning">‚ö† Partial</span>
                                    {% else %}
                                        <span class="status-badge">{{ entry.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <!-- Getting Started Guide -->
    {% if template_count == 0 and team_count == 0 %}
        <div class="section">
            <div class="info-box">
                <h3>üöÄ Getting Started</h3>
                <ol class="getting-started">
                    <li>
                        <strong>Create a template</strong> - Define how your EPG programs will look (titles, descriptions, filler content, etc.)
                    </li>
                    <li>
                        <strong>Add teams</strong> - Add your favorite sports teams using their ESPN URLs
                    </li>
                    <li>
                        <strong>Assign templates</strong> - Assign each team to a template (or use bulk assignment)
                    </li>
                    <li>
                        <strong>Generate EPG</strong> - Click "Generate EPG" to create your XMLTV file
                    </li>
                </ol>
            </div>
        </div>
    {% endif %}
</div>

<style>
.page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 0;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    gap: 2rem;
}

.page-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    color: var(--text-primary);
}

.page-subtitle {
    margin: 0;
    color: var(--text-muted);
    font-size: 1rem;
}

.page-actions {
    display: flex;
    gap: 0.75rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stats-grid-compact {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    transition: box-shadow 0.2s;
}

.stat-card-compact {
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stat-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.stat-icon-compact {
    font-size: 1rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
}

.stat-value-compact {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.stat-label-compact {
    color: var(--text-muted);
    font-size: 0.7rem;
    margin-top: 0.1rem;
}

.stat-value-tiny {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary);
    line-height: 1.2;
}

.epg-stats {
    margin-bottom: 2rem;
}

.epg-stats h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.stat-value-small {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
    line-height: 1.2;
}

.epg-stat {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
}

.section {
    margin-bottom: 2rem;
}

.section h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.manage-link {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: color 0.2s, background-color 0.2s;
}

.manage-link:hover {
    color: var(--primary);
    background-color: rgba(59, 130, 246, 0.1);
}

.info-box {
    background: rgba(59, 130, 246, 0.15);
    border: 1px solid var(--primary);
    border-radius: 8px;
    padding: 1.5rem;
}

.info-box h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--primary);
}

.getting-started {
    margin: 0;
    padding-left: 1.5rem;
}

.getting-started li {
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
}

/* History Table Styles */
.table-container {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.history-table thead {
    background: var(--bg-tertiary);
    border-bottom: 2px solid var(--border);
}

.history-table th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
}

.history-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

.history-table tbody tr:last-child td {
    border-bottom: none;
}

.history-table tbody tr:hover {
    background: var(--bg-tertiary);
}

.text-center {
    text-align: center;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-success {
    background: rgba(34, 197, 94, 0.2);
    color: #86efac;
}

.status-error {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
}

.status-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #fcd34d;
}
</style>

<script>
function showEPGUrl() {
    const url = window.location.origin + '/teamarr.xml';
    const message = `
        <strong>EPG URL for IPTV:</strong><br>
        <input type="text" value="${url}" readonly onclick="this.select()"
               style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 4px; font-family: monospace;">
        <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">
            Click the URL to select it, then copy and paste into your IPTV app.
        </small>
    `;
    showNotification(message, 'info', 0, 'EPG URL');
}
</script>
{% endblock %}
